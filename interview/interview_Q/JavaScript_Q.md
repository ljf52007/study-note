# `JS`执行机制

> `JS`为什么单线程?

1. 首先区分进程与线程的概念.

   本质上来说,这两个名词都是`CPU`工作时间片上的一个描述.

   进程描述了`CPU`在运行指令及加载和保存上下文所需的时间,放在应用上来说就是一个程序.线程是进程中的更小单位,描述了执行一段指令所需的时间.

   把这些概念放到浏览器来说,当我们打开一个`Tab`页,其实就是创建了一个进程,一个进程中可以有多个线程,如`渲染线程,JS引擎线程,http请求线程`等等.比如,当我们发出一个请求时,其实就是创建了一个线程,当请求结束后,该线程可能会被销毁.

2. `JS`为什么是单线程?

   `JavaScript`作为浏览器的脚本语言,主要用途是与用户互动,操作`DOM`等,这决定了它只能是单线程,否则会带来复杂的同步问题.

   比如,前面提到了`JS引擎线程和渲染线程`,这两个线程是互斥的,`JS`运行时可能会阻塞渲染.这是因为`JS`可以修改`DOM`,如果`JS`执行的时候渲染线程也在工作,就可能导致不能安全的渲染界面.例如,假如同时有两个线程在工作,一个线程在某个`DOM`节点上添加内容,另一个线程却删除了这个节点,这就导致了冲突.

   所以,单线程有单线程的好处,得益于`JS`是单线程运行的,可以达到节省内存,节约上下文切换时间,没有锁的问题等好处.

   

> 有什么办法多线程吗?

为了利用多核`CPU`的计算能力,`HTML5`提出了`Web Worker`标准,允许`JavaScript`脚本创建多个线程,但是子线程完全受主线程的控制,且不得操作`DOM`.因此,这个新标准并没有改变`JavaScript`单线程的本质.



> 单线程带来的问题和解决方法

`JavaScript`单线程就意味着,所有任务需要排队执行,前一个任务结束,才会执行下一个任务.如果前一个任务耗时很长,后一个任务也不得不一直等着.

如果排队是因为计算量大,`CPU`忙不过来也就算了,但很多时候`CPU`是闲着的,因为`IO`设备(输入输出设备)很慢(比如`Ajax`请求数据),不得不等着结果出来,再往下执行.

`JavaScript`语言的设计者意识到,这时主线程完全可以不管`IO`设备,挂起处于等待中的任务,先运行排在后面的任务.等到`IO`设备返回了结果,再回过头,把挂起的任务继续执行下去.

于是,所有的任务可以分为两种——`同步任务和异步任务`.`同步任务`指的是,在主线程上排队执行的任务,只有前一个任务执行完毕,才能执行后一个任务;`异步任务`指的是,不进入主线程,而进入`任务队列(task queue)`的任务,只有`task queue`通知主线程,某个异步任务可以执行了,该任务该会进入主线程执行.

















