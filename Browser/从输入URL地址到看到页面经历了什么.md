## 1 `URL`解析

`url`,统一资源定位符`(Uniform Resource Locator)`,是互联网上标准资源的地址.互联网上每个文件都有一个唯一的`url`,它包含的信息指出文件的位置以及浏览器应该怎么处理它.

一个完整的`url`:

```url
http://user:pass@www.xxx.cn:80/index.html?a=1&b=2#video
```

| 组成         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| `http`       | 通信协议，如`http`、`https`、`ftp`、`maito`等                |
| `user:pass`  | 登录信息(认证)                                               |
| `www.xxx.cn` | 主机（域名），如`www.baidu.com`                              |
| `:80`        | 端口号，可选，省略则使用方案的默认端口，如`http`默认端口为`80` |
| `index.html` | 请求资源的文件路径，一般用来表示主机上的一个目录或文件地址   |
| `?a=1&b=2`   | 参数，以键值对的方式，通过`&`符号分隔开来                    |
| `#video`     | 片段标识符，`#`后面的内容，常见于链接锚点                    |



## 2 缓存检查

1. 缓存位置:分为`内存缓存(Memory Cache)`和`硬盘缓存(Disk Cache)`

   - 打开网页：查找 `disk cache` 中是否有匹配，如有则使用，如没有则发送网络请求
   - 普通刷新 (`F5`)：因`TAB`没关闭，因此`memory cache`是可用的，会被优先使用，其次才是`disk cache`
   - 强制刷新 (`Ctrl + F5`)：浏览器不使用缓存，因此发送的请求头部均带有 `Cache-control: no-cache`，服务器直接返回 `200` 和最新内容

2. 强缓存:分为`Expires`和`Cache-Control`.

   浏览器对于强缓存的处理是根据第一次请求资源时返回的响应头来确定的.

   - `Expires`:缓存过期时间,用来指定资源到期的时间`(HTTP/1.0)`;
   - `Cache-Control: cache-control: max-age=2592000`:第一次拿到资源后的`2592000`秒内(30天),再次发送请求,读取缓存中的信息`(HTTP/1.1)`
   - 两者同时存在的话,`Cache-Control`优先级高于`Expires`

   ![img](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151334.png)

   

3. 协商缓存`(Last-Modified/ETag)`:就是强缓存失效后,浏览器携带缓存标识向服务器发起请求,由服务器根据缓存标识决定是否使用缓存的过程.

   ![20210326151406](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151406.png)

4. 数据缓存

   ![20210326151432](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151432.png)



## 3 `DNS`解析

**解析过程**

当用户在地址栏输入一个`url`,如`www.taobao.com`,`DNS`解析过程如下:

1. `浏览器先检查自身缓存`中有没有被解析过的这个域名对应的`ip`地址,如果有,解析结束;
2. 如果浏览器缓存没有命中该域名,浏览器会检查`操作系统缓存`中有没有对应的已解析过的结果.(通过`hosts`文件设置,但因为容易被黑客攻击,所以该文件默认是`readonly`只读状态,防止被恶意篡改);
3. 如果`hosts`文件没有命中该域名,才会真正请求`本地域名服务器(LDNS)`来解析这个域名.本地域名服务器一般距离客户端不会太远,一般都会缓存域名解析结果.
4. 如果本地域名服务器仍然没有命中,它会向`根域名服务器`发送请求.
5. 根域名服务器查询该域名,返回给本地域名服务器一个所查询域的`主域名服务器`(国际顶尖域名服务器,如`.com .cn .org`等)地址,本地域名服务器收到后再向该地址发送请求;
6. 顶级域名服务器查询该域名,返回给本地域名服务器一个所查询域的`权威域名服务器`(如`google.com`)地址,权威域名服务器根据映射关系表找到目标`ip`,返回给本地域名服务器;
7. 本地域名服务器缓存这个域名和对应的`ip`;
8. 本地域名服务器把解析的结果返回给用户,用户缓存到本地系统,域名解析过程结束.

![20210326151502](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151502.png)

**优化:**

- 减少`DNS`请求次数;

- `DNS`预获取`(DNS Prefetch)`

  ```html
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="//static.360buyimg.com"/>
  <link rel="dns-prefetch" href="//misc.360buyimg.com"/>
  <link rel="dns-prefetch" href="//img10.360buyimg.com"/>
  <link rel="dns-prefetch" href="//d.3.cn"/>
  <link rel="dns-prefetch" href="//d.jd.com"/>
  ```

**服务器拆分的优势**

- 资源的合理利用;
- 抗压能力加强;
- 提高`HTTP`并发

![20210326151614](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151614.png)



## 4 `TCP`三次握手

![20210326151731](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151731.png)

**标识说明:**

- `seq`序号，用来标识从`TCP`源端向目的端发送的字节流，发起方发送数据时对此进行标记 
- `ack`确认序号，只有`ACK`标志位为`1`时，确认序号字段才有效，`ack=seq+1`
- 标志位
  - `ACK`：确认序号有效
  - `RST`：重置连接
  - `SYN`：发起一个新连接
  - `FIN`：`finish`,终结的意思,释放一个连接

**三次握手过程:**

1. 第一次握手：建立连接。客户端发送连接请求报文段，将`SYN`置1，序列号`seq(sequence number)`为x；然后，客户端进入`SYN_SEND`状态，等待服务器的确认。

2. 第二次握手：服务器收到`SYN`报文段,对这个`SYN`报文段进行确认，`ACK`置1，表示同意连接,确认号`ack(acknowledgement number)`为`x+1`；同时，服务器还要发送`SYN`请求信息，将`SYN`置1，序列号`seq`为`y`；服务器将上述`SYN+ACK`报文段一并发送给客户端，此时服务器进入`SYN_RECV`状态。

3. 第三次握手：客户端收到服务器的`SYN+ACK`报文段。然后将确认号`ack`设置为`y+1`，向服务器发送`ACK`报文段。这个报文段发送完毕后，客户端和服务器都进入`ESTABLISHED`状态，完成`TCP`三次握手，之后可以开始传数据。

为什么需要三次握手?

为了保证**服务器能接收到客户端的信息并做出正确的应答**而进行前两次（第一次和第二次）握手，为了保证**客户端能够接收到服务端的信息并能做出正确的应答**而进行后两次（第二次和第三次）握手。传输的信道实际上是不可靠的,所以要想数据传输可靠,至少要做到三次握手,三次是理论上的最小值.



## 5 数据传输

**`http`报文:**

- 请求报文
- 响应报文



## 6 `TCP`四次挥手

当客户端和服务器通过三次握手建立了`TCP`连接之后，当数据传输完毕，就要断开`TCP`连接，这个过程称为四次挥手.

![20210326151917](https://gitee.com/ljf52007/note/raw/master/interview/interview_Q/Http_Q.assets/20210326151917.png)

**四次挥手过程:**

1. 第一次挥手：主机1（可以是客户端，也可以是服务器）设置序列号`seq`为`u`，向主机2发送一个`FIN`报文段；此时，主机1进入`FIN_WAIT`状态，这表示主机1没有数据要发送给主机2了。

2. 第二次挥手：主机2收到了主机1发送的`FIN`报文段，向主机1回复一个`ACK`报文段，确认号`ack`为`u+1`，序列号`seq`为`v`；主机2进入CLOSE_WAIT状态；主机1收到主机2发送的`ACK`报文段之后，进入`FIN_WAIT_2`状态。

3. 第三次挥手：主机2向主机1发送`FIN`报文段，设置序列号`seq`为`w`，确认号`ack`为`u+1`，请求关闭连接，同时主机2进入`LAST_ACK`状态

4. 第四次挥手：主机1收到主机2发送的`FIN`报文段，向主机2发送`ACK`报文段，确认号`ack`为`w+1`，序列号`seq`为`u+1`，然后主机1进入`TIME_WAIT`状态；主机2收到主机1的`ACK`报文段以后，就关闭连接；此时，主机1等待`2MSL(MSL,最长报文段寿命)`后依然没有收到回复，则证明服务端已经正常关闭，那么主机1也可以关闭连接了。

**为什么需要四次挥手?**

挥手次数比握手次数多了一次的主要原因在于

- 服务器端收到客户端的`SYN`连接请求报文后，可以直接发送`SYN+ACK`报文;
- 但关闭连接时，当服务器端收到`FIN`报文时，很可能并不会立即关闭链接，所以只能先回复一个`ACK`报文，告诉客户端：”你发的`FIN`报文我收到了，只有等到服务器端所有的报文都发送完了，我才能发送`FIN`报文，因此不能一起发送"，故需要四步握手.

**挥手过程中如果客户端先挂断了,服务器端会发生什么?**

`TCP`设有一个保活计时器,绑定每一个客户端,超过这个计时器设定的时间,还没有收到应答报文段,服务器端就会发送探测报文段(一般连续发送10个左右),如果还是没有回应,服务器端判定客户端出现问题,关闭连接.



## 7 页面渲染